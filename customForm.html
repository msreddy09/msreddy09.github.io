<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Entry Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Make all form elements full-width on all devices */
        .form-control,
        .form-select {
            width: 100% !important;
        }

        /* Force bootstrap columns into full width ALWAYS */
        .col-md-4,
        .col-md-6,
        .col-md-3 {
            width: 100% !important;
            max-width: 100% !important;
            flex: 0 0 100% !important;
        }

        /* Reduce card padding on smaller devices */
        @media (max-width: 768px) {
            .card {
                padding: 20px !important;
            }
        }

        /* Make buttons full width on mobiles for better UI */
        @media (max-width: 600px) {
            button[type="submit"] {
                width: 100%;
            }
        }

        nav.navbar {
            padding: 0 !important;
        }

        .navbar-brand {
            font-size: 1.3rem;
        }

        .sidebar {
            height: 100%;
            width: 260px;
            position: fixed;
            top: 0;
            left: -260px;
            background: #ffffff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            transition: 0.3s ease;
            z-index: 9999;
            padding-top: 10px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
        }

        .close-btn {
            font-size: 26px;
            cursor: pointer;
        }

        .sidebar-link {
            display: block;
            padding: 12px 10px;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
        }

        .sidebar-link:hover {
            background: #f0f0f0;
        }

        .overlay {
            position: fixed;
            display: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.35);
            z-index: 9998;
        }

        .modal-header {
            padding: 10px;
        }

        .initial-circle {
            width: 32px;
            height: 32px;
            min-width: 32px;
            /* stops shrinking */
            min-height: 32px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.3rem;
            color: #333;
            flex-shrink: 0;
        }

        .text-xs {
            font-size: 0.65rem !important;
            /* extra small */
            line-height: 1.1rem;

        }

        .add-tran-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #25D366;
            /* WhatsApp green */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
            text-decoration: none;
            transition: 0.2s ease-in-out;
        }

        .add-tran-btn:hover {
            transform: scale(1.1);
            color: white;
        }

        select.form-select {
            min-width: 100%;
            padding: 10px;
            font-size: 16px;
        }
    </style>

</head>

<body class="bg-light">
    <!-- HEADER -->
    <nav class="navbar navbar-light bg-primary shadow-sm">
        <div class="container-fluid d-flex align-items-center">

            <!-- Hamburger -->
            <button id="openSidebar" class="btn text-white me-2" style="font-size: 24px;">
                ☰
            </button>

            <!-- Center Company Name -->
            <div class="flex-grow-1 text-center">
                <span class="navbar-brand mb-0 h1 text-white fw-bold">
                    KIM's Farm
                </span>
            </div>

            <!-- Spacer to keep title centered -->
            <div style="width: 32px;"></div>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0">Menu</h5>
            <span id="closeSidebar" class="close-btn">×</span>
        </div>

        <ul class="list-unstyled px-3 mt-3">
            <li><a href="#" class="sidebar-link">Dashboard</a></li>
            <li><a href="#" class="sidebar-link">Reports</a></li>
            <li><a href="#" class="sidebar-link">Settings</a></li>
            <li><a href="#" class="sidebar-link">Logout</a></li>
        </ul>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>


    <div class="list-group" id="rowsdata">

        <!-- Transaction Item -->

    </div>

    <!-- <div id="rowsdata" class="mt-4"></div> -->
    <!-- <div class="fixed-bottom d-flex justify-content-center align-items-center bg-light py-2" style="gap: 1rem;">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#googleFormModalcashin">
            Cash In / Cash Out
        </button>
    </div> -->
    <a href="#" class="add-tran-btn" data-bs-toggle="modal" data-bs-target="#googleFormModalcashin">
        <i class="bi bi bi-plus"></i>
    </a>


    <!-- Modal -->
    <div class="modal fade" id="googleFormModalcashin" tabindex="-1" aria-labelledby="googleFormModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="googleFormModalLabel">Cash Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="card shadow p-4">
                        <div id="loadingText"> Loading....</div>
                        <form id="cashForm">
                            <div class="row">
                                <div class="col-6 col-xs-6">
                                    <label class="form-label">Date</label>
                                    <input type="date" id="dateInput" class="form-control" name="date" required>
                                </div>
                                <div class="col-6 col-xs-6">
                                    <label class="form-label">Time</label>
                                    <input type="time" id="timeInput" class="form-control" name="time" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Party</label>
                                    <select class="form-select" name="party">
                                        <option value="">Select Party</option>
                                        <option value="Ravi">Ravi</option>
                                        <option value="Suresh">Suresh</option>
                                        <option value="Venkat">Venkat</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" name="category" required>
                                        <option value="">Select Category</option>
                                        <option value="Food">Food</option>
                                        <option value="Farm Lease">Farm Lease</option>
                                        <option value="Transport">Transport</option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Mode</label>
                                    <select class="form-select" name="mode" required>
                                        <option value="Online">Online</option>
                                        <option value="Cash">Cash</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Cash In</label>
                                    <input type="number" step="0.01" class="form-control" name="cashin">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Cash Out</label>
                                    <input type="number" step="0.01" class="form-control" name="cashout">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Remarks</label>
                                    <input type="text" class="form-control" name="remarks" required>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Enter By</label>
                                    <select class="form-select" name="enterby" required>
                                        <option value="Admin">Admin</option>
                                        <option value="User1">User1</option>
                                        <option value="User2">User2</option>
                                    </select>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn btn-primary px-4">Submit</button>
                            </div>
                        </form>

                        <div id="msg" class="text-center mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- REQUIRED Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        const API_URL = "https://googel-proxy.msudhakarreddy09.workers.dev/";
        let editRowId = null;
        loadingText.style.display = 'none';
        /** Fetch wrapper that always returns JSON or text */
        const fetchJSON = async (url, options = {}) => {
            const response = await fetch(url, options);
            const text = await response.text();
            try { return JSON.parse(text); }
            catch { return text; }
        };

        /** Convert dd/MM/yyyy → yyyy-MM-dd */
        const formatToInputDate = (dateStr) => {
            const [d, m, y] = dateStr.split("/");
            return `${y}-${m}-${d}`;
        };

        function setCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");
            document.getElementById("timeInput").value = `${hours}:${minutes}`;
        }

        // Set time on page load
        setCurrentTime();

        function setToday() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');

            document.getElementById("dateInput").value = `${year}-${month}-${day}`;
        }

        setToday();

        function formatTimeFromSheet(value) {
            const date = new Date(value);
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, "0");
            const seconds = date.getSeconds().toString().padStart(2, "0");
            const ampm = hours >= 12 ? "PM" : "AM";
            // Convert to 12-hour format
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 becomes 12

            return `${hours.toString().padStart(2, "0")}:${minutes} ${ampm}`;
        }

        /** Populate the UI with saved rows */
        const getRowsData = async () => {
            const result = await fetchJSON(API_URL);

            if (!result.success) {
                rowsdata.innerHTML = "<b>Error loading data</b>";
                return;
            }

            const rows = result.data;

            if (!rows.length) {
                rowsdata.innerHTML = "<b>No Data to display</b>";
                return;

            }

            const grouped = rows.reduce((acc, item) => {
                if (!acc[item.Date]) {
                    acc[item.Date] = [];
                }
                acc[item.Date].push(item);
                return acc;
            }, {});


            rowsdata.innerHTML = '';

            for (let key in grouped) {
                if (grouped[key]) {

                    // DATE HEADER
                    rowsdata.innerHTML += `<div class="px-2 py-1 small">${key}</div>`;

                    // ROWS UNDER THIS DATE
                    rowsdata.innerHTML += grouped[key].map(r => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                
                                ${r.Party ? `<div class="initial-circle me-2">
                                    <span>${r.Party[0]}</span>
                                </div>`: ''}

                                <div>
                                    <div class="fw-semibold">${r.Category}</div>
                                    <div class="text-muted small">${r.Remarks}</div>
                                </div>
                            </div>

                            <div class="text-end">

                                ${r['Cash In'] > 0
                            ? `<div class="text-success fw-semibold">${amountsInINR(r['Cash In'])}</div>`
                            : ''}

                                ${r['Cash Out'] > 0
                            ? `<div class="text-danger fw-semibold">${amountsInINR(r['Cash Out'])}</div>`
                            : ''}

                                <div class="text-muted small">${formatTimeFromSheet(r.Time)}</div>
                            </div>
                        </div>
                    `).join("");
                }
            }



        };

        function amountsInINR(amount) {
            return amount.toLocaleString('en-IN', {
                style: 'currency',
                currency: 'INR',
            })
        }
        function openCashInModal() {
            var myModal = new bootstrap.Modal(document.getElementById('googleFormModalcashin'));
            myModal.show();

        }
        function closeCashInModal() {
            var modalEl = document.getElementById('googleFormModalcashin');
            var modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();

        }
        /** Delete a row */
        const deleteRowData = async (id) => {
            const result = await fetchJSON(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "delete", id })
            });

            getRowsData();
        };

        /** Load row into form for editing */
        const editRowData = async (id) => {
            openCashInModal();
            cashForm.style.display = 'none';
            loadingText.style.display = '';
            const result = await fetchJSON(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "edit", id })
            });

            const data = result?.record;
            if (!data) return;

            editRowId = data.ID;

            cashForm.date.value = formatToInputDate(data.Date);
            cashForm.party.value = data.Party;
            cashForm.category.value = data.Category;
            cashForm.mode.value = data.Mode;
            cashForm.cashin.value = data["Cash In"];
            cashForm.cashout.value = data["Cash Out"];
            cashForm.enterby.value = data["Enter By"];
            cashForm.remarks.value = data.Remarks;
            loadingText.style.display = 'none';
            cashForm.style.display = '';
        };

        /** Submit handler (add / update) */
        cashForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const payload = Object.fromEntries(new FormData(e.target));
            if (editRowId) payload.id = editRowId;

            const result = await fetchJSON(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            editRowId = null;
            cashForm.reset();
            closeCashInModal();
            getRowsData();
        });

        // Initial load
        getRowsData();

        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");

        document.getElementById("openSidebar").onclick = () => {
            sidebar.style.left = "0px";
            overlay.style.display = "block";
        };

        document.getElementById("closeSidebar").onclick = closeSidebar;
        overlay.onclick = closeSidebar;

        function closeSidebar() {
            sidebar.style.left = "-260px";
            overlay.style.display = "none";
        }
    </script>
</body>

</html>